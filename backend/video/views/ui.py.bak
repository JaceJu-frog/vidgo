# views/ui.py
from django.views.generic import TemplateView

class IndexView(TemplateView):
    template_name = "index.html"

class SettingView(TemplateView):
    template_name = "settings.html"

class WatchVideoView(TemplateView):
    def watch_video(request, subpath):
        print("watch video")
        
        # 自动解码 URL 编码的路径参数
        decoded_path = urllib.parse.unquote(subpath)
        print(subpath)
        print(decoded_path)
        absolute_path=decoded_path
        # 数据库查询 (Django ORM 方式)
        video = Video.objects.filter(url=decoded_path).first()
        last_open_time=record_video_last_open(video.id)  # 记录视频最后打开时间
        if not video:
            return HttpResponseNotFound("Video not found in database")
        
        # 检查文件存在性
        if not os.path.exists(os.path.join(settings.MEDIA_ROOT, "saved_video", absolute_path)):
            raise Http404("Video file not found")
        
        # 构建视频 URL (使用 Django URL 反向解析)
        # Remove any duplicate 'media' segments from path
        print("absolute_path",absolute_path)
        video_path = request.build_absolute_uri(
            reverse('video:serve_media', args=[absolute_path.split('/media/saved_video/')[-1]])
        )
        print(video_path)
        
        return render(request, 'video.html', {
            'video_path': video_path,
            'video_id': video.id
        })